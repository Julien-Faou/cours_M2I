# Enumération passive

# Network mapping

## Finger printing des ports ouverts
- Quels sont les ports TCP et UDP ouverts ? et les services qui tournent deriière

* Envois un echo request sur l'adresse IP => savoir si il a un hôte
```
nmap -sn scanme.nmap.org
```

* Quels servicent sont sur ce site ? 
```
nmap -sS scanme.nmap.org
```

```
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 07:26 EDT
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.35s latency).
Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f
Not shown: 992 closed ports
PORT      STATE SERVICE
21/tcp    open  ftp
22/tcp    open  ssh
80/tcp    open  http
443/tcp   open  https
554/tcp   open  rtsp
1723/tcp  open  pptp
9929/tcp  open  nping-echo
31337/tcp open  Elite
```

C'est la méthode la plus sûre pour ne pas se faire toper par un IDS
Envois juste un SYN et voit si ça répond

-sS => stelf scan

* STATE : filtered => proxy qui va passer la connexion au serveur seulement si la connexion est établie (SYN, SYN ACK, ACK). 

* Par défaut les serveurs linux ne log que les connexions établies ! -sS n'envoit pas le dernier ACK

* Scan TCP
```
sudo nmap -sT scanme.nmap.org
```

```
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 07:42 EDT
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.19s latency).
Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f
Not shown: 992 closed ports
PORT      STATE SERVICE
21/tcp    open  ftp
22/tcp    open  ssh
80/tcp    open  http
443/tcp   open  https
554/tcp   open  rtsp
1723/tcp  open  pptp
9929/tcp  open  nping-echo
31337/tcp open  Elite
```

```
sudo nmap -sU scanme.nmap.org
```

* Le scan de port UDP est beaucoup plus long, nmap va tester plusieurs commandes par port pour voir si ça répond, va chercker la commande DNS sur le port 53, si ça rep pas il va tester les commandes de tous les ports les plus connus.
==> __super voyant !__

* Pour aller plus vite on peut jouer ave l'option -T  Timer agressive => réduit le temps des timers, le risque si trop élevé et que le serveur soit trop bourré pour répondre à temps.


## Fingerprinting des services

```
nc -vv scanme.nmap.org 80
```

-vv => Verbose

```
scanme.nmap.org [45.33.32.156] 80 (http) open
d
HTTP/1.1 400 Bad Request
Date: Thu, 15 Oct 2020 12:05:12 GMT
Server: Apache/2.4.7 (Ubuntu)
Content-Length: 306
Connection: close
Content-Type: text/html; charset=iso-8859-1

<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>400 Bad Request</title>
</head><body>
<h1>Bad Request</h1>
<p>Your browser sent a request that this server could not understand.<br />
</p>
<hr>
<address>Apache/2.4.7 (Ubuntu) Server at scanme.nmap.org Port 80</address>
</body></html>
 sent 2, rcvd 487
```

__=> Beaucoup plus discret un NC qu'nmap__

```
sudo nmap -sV -p 80 scanme.nmap.org
```

```
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 08:11 EDT
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.0049s latency).
Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.7 ((Ubuntu))

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.54 seconds
```

```
sudo nmap -sV -p 31337 scanme.nmap.org
```

```
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 08:08 EDT
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.050s latency).
Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f

PORT      STATE SERVICE    VERSION
31337/tcp open  tcpwrapped

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 2.64 seconds
```

__=> tcp redirigé vers un autre port de la machine, pas réussis à trouver le service__


```
sudo nmap -sV scanme.nmap.org
```

```
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 08:15 EDT
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.19s latency).
Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f
Not shown: 992 closed ports
PORT      STATE SERVICE    VERSION
21/tcp    open  tcpwrapped
22/tcp    open  ssh        OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)
80/tcp    open  http       Apache httpd 2.4.7 ((Ubuntu))
443/tcp   open  tcpwrapped
554/tcp   open  rtsp?
1723/tcp  open  tcpwrapped
9929/tcp  open  nping-echo Nping echo
31337/tcp open  tcpwrapped
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 116.27 seconds
```


## Fingerprinting de l'OS 

```
sudo nmap -O scanme.nmap.org
```

```
21/tcp    open  ftp
22/tcp    open  ssh
80/tcp    open  http
443/tcp   open  https
554/tcp   open  rtsp
1723/tcp  open  pptp
9929/tcp  open  nping-echo
31337/tcp open  Elite
Aggressive OS guesses: Actiontec MI424WR-GEN3I WAP (93%), DD-WRT v24-sp2 (Linux 2.4.37) (92%), Linux 3.2 (91%), Linux 4.4 (90%), Microsoft Windows XP SP3 (90%), Microsoft Windows XP SP3 or Windows 7 or Windows Server 2012 (90%), BlueArc Titan 2100 NAS device (90%), FireBrick FB2700 firewall (87%), IBM BladeCenter management module, IBM System Storage TS3100/TS3200 Express Model tape library, or HP StorageWorks MSL2024 tape library (87%), Pirelli DP-10 VoIP phone (87%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 26 hops
```

__LINUX__, nmap se base sur le payload des réponses pour déterminer l'OS, la longueur, le temps de réponse, le contenu varies d'un OS à un autre.

__26 sauts__

```
traceroute scanme.nmap.org
```

```
traceroute to 45.33.32.156 (45.33.32.156), 30 hops max, 60 byte packets
 1  172.16.66.2 (172.16.66.2)  0.389 ms  0.239 ms  0.439 ms
 2  _gateway (192.168.43.1)  5.278 ms  5.074 ms  4.940 ms
 3  10.125.160.5 (10.125.160.5)  23.847 ms  26.652 ms  32.521 ms
 4  10.125.161.82 (10.125.161.82)  32.444 ms  32.283 ms  32.993 ms
 5  10.162.36.50 (10.162.36.50)  32.804 ms  32.634 ms  32.468 ms
 6  89.89.101.10 (89.89.101.10)  32.302 ms  34.489 ms  37.574 ms
 7  62.34.2.30 (62.34.2.30)  37.416 ms  30.329 ms  30.235 ms
 8  62.34.2.60 (62.34.2.60)  31.569 ms  35.021 ms  34.954 ms
 9  212.194.170.253 (212.194.170.253)  45.222 ms  45.377 ms  45.090 ms
10  be4887.agr21.mrs01.atlas.cogentco.com (149.14.126.217)  56.194 ms  56.134 ms  56.074 ms
11  be2346.ccr22.mrs01.atlas.cogentco.com (154.54.38.173)  56.730 ms  55.947 ms  39.609 ms
12  be3092.ccr41.par01.atlas.cogentco.com (130.117.49.153)  42.653 ms be3093.ccr42.par01.atlas.cogentco.com (130.117.50.165)  42.448 ms be3092.ccr41.par01.atlas.cogentco.com (130.117.49.153)  39.135 ms
13  be12489.ccr42.lon13.atlas.cogentco.com (154.54.57.69)  48.364 ms be12497.ccr41.lon13.atlas.cogentco.com (154.54.56.129)  53.034 ms  53.193 ms
14  be2099.ccr31.bos01.atlas.cogentco.com (154.54.82.34)  116.338 ms be2101.ccr32.bos01.atlas.cogentco.com (154.54.82.38)  116.285 ms  116.226 ms
15  be3600.ccr22.alb02.atlas.cogentco.com (154.54.0.221)  118.722 ms  118.305 ms  118.567 ms
16  be2878.ccr21.cle04.atlas.cogentco.com (154.54.26.129)  129.611 ms  129.612 ms  129.562 ms
17  be2718.ccr42.ord01.atlas.cogentco.com (154.54.7.129)  186.580 ms  186.470 ms  186.410 ms
18  be2831.ccr21.mci01.atlas.cogentco.com (154.54.42.165)  152.033 ms  156.927 ms be2832.ccr22.mci01.atlas.cogentco.com (154.54.44.169)  156.765 ms
19  be3035.ccr21.den01.atlas.cogentco.com (154.54.5.89)  180.882 ms be3036.ccr22.den01.atlas.cogentco.com (154.54.31.89)  151.750 ms be3035.ccr21.den01.atlas.cogentco.com (154.54.5.89)  161.721 ms
20  be3038.ccr32.slc01.atlas.cogentco.com (154.54.42.97)  168.204 ms  172.076 ms  171.969 ms
21  be3110.ccr22.sfo01.atlas.cogentco.com (154.54.44.141)  189.691 ms be3109.ccr21.sfo01.atlas.cogentco.com (154.54.44.137)  185.893 ms be3110.ccr22.sfo01.atlas.cogentco.com (154.54.44.141)  189.248 ms
22  be3178.ccr21.sjc01.atlas.cogentco.com (154.54.43.70)  189.099 ms  179.455 ms  184.264 ms
23  be2063.rcr21.b001848-1.sjc01.atlas.cogentco.com (154.54.1.162)  183.170 ms be2095.rcr21.b001848-1.sjc01.atlas.cogentco.com (154.54.3.138)  187.045 ms  186.965 ms
24  38.142.11.154 (38.142.11.154)  188.374 ms  186.812 ms  178.271 ms
25  173.230.159.65 (173.230.159.65)  189.209 ms  189.095 ms  192.352 ms
26  scanme.nmap.org (45.33.32.156)  188.726 ms  176.661 ms  182.252 ms
```

__Il est possible d'avoir des * * * * à la place, c'est normal => on rentre dans des routeurs privés avec des ACL.__


### xprobe
```
xprobe2 scanme.nmap.org
```

```
sudo xprobe2 scanme.nmap.org

Xprobe2 v.0.3 Copyright (c) 2002-2005 fyodor@o0o.nu, ofir@sys-security.com, meder@o0o.nu

[+] Target is scanme.nmap.org
[+] Loading modules.
[+] Following modules are loaded:
[x] [1] ping:icmp_ping  -  ICMP echo discovery module
[x] [2] ping:tcp_ping  -  TCP-based ping discovery module
[x] [3] ping:udp_ping  -  UDP-based ping discovery module
[x] [4] infogather:ttl_calc  -  TCP and UDP based TTL distance calculation
[x] [5] infogather:portscan  -  TCP and UDP PortScanner
[x] [6] fingerprint:icmp_echo  -  ICMP Echo request fingerprinting module
[x] [7] fingerprint:icmp_tstamp  -  ICMP Timestamp request fingerprinting module
[x] [8] fingerprint:icmp_amask  -  ICMP Address mask request fingerprinting module
[x] [9] fingerprint:icmp_port_unreach  -  ICMP port unreachable fingerprinting module
[x] [10] fingerprint:tcp_hshake  -  TCP Handshake fingerprinting module
[x] [11] fingerprint:tcp_rst  -  TCP RST fingerprinting module
[x] [12] fingerprint:smb  -  SMB fingerprinting module
[x] [13] fingerprint:snmp  -  SNMPv2c fingerprinting module
[+] 13 modules registered
[+] Initializing scan engine
[+] Running scan engine
[-] ping:tcp_ping module: no closed/open TCP ports known on 45.33.32.156. Module test failed
[-] ping:udp_ping module: no closed/open UDP ports known on 45.33.32.156. Module test failed
[-] No distance calculation. 45.33.32.156 appears to be dead or no ports known
[+] Host: 45.33.32.156 is up (Guess probability: 50%)
[+] Target: 45.33.32.156 is alive. Round-Trip Time: 0.50697 sec
[+] Selected safe Round-Trip Time value is: 1.01394 sec
[-] fingerprint:tcp_hshake Module execution aborted (no open TCP ports known)
[-] fingerprint:smb need either TCP port 139 or 445 to run
[-] fingerprint:snmp: need UDP port 161 open
[+] Primary guess:
[+] Host 45.33.32.156 Running OS: �z��V (Guess probability: 89%)
[+] Other guesses:
[+] Host 45.33.32.156 Running OS: �z��V (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS: �z��V (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS: �z��V (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS:  (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS: ����V (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS: �z��V (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS: �z��V (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS:  (Guess probability: 89%)
[+] Host 45.33.32.156 Running OS: ����V (Guess probability: 89%)
[+] Cleaning up scan engine
[+] Modules deinitialized
[+] Execution completed.
```

## Pourquoi il ne faut jamais utiliser nmap dans une grosse structure ?

```
sudo nmap --packet-trace -p 80 -sT scanme.nmap.org
```

```
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 09:22 EDT
SENT (0.0790s) ICMP [172.16.66.131 > 45.33.32.156 Echo request (type=8/code=0) id=40162 seq=0] IP [ttl=42 id=29061 iplen=28 ]
SENT (0.0791s) TCP 172.16.66.131:47724 > 45.33.32.156:443 S ttl=41 id=33834 iplen=44  seq=821924815 win=1024 <mss 1460>
SENT (0.0792s) TCP 172.16.66.131:47724 > 45.33.32.156:80 A ttl=41 id=57855 iplen=40  seq=0 win=1024 
SENT (0.0793s) ICMP [172.16.66.131 > 45.33.32.156 Timestamp request (type=13/code=0) id=27588 seq=0 orig=0 recv=0 trans=0] IP [ttl=49 id=54644 iplen=40 ]
RCVD (0.0793s) TCP 45.33.32.156:80 > 172.16.66.131:47724 R ttl=128 id=8773 iplen=40  seq=821924815 win=32767 
NSOCK INFO [0.1220s] nsock_iod_new2(): nsock_iod_new (IOD #1)
NSOCK INFO [0.1220s] nsock_connect_udp(): UDP connection requested to 172.16.66.2:53 (IOD #1) EID 8
NSOCK INFO [0.1230s] nsock_read(): Read request from IOD #1 [172.16.66.2:53] (timeout: -1ms) EID 18
NSOCK INFO [0.1230s] nsock_write(): Write request for 43 bytes to IOD #1 EID 27 [172.16.66.2:53]
NSOCK INFO [0.1230s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 8 [172.16.66.2:53]
NSOCK INFO [0.1230s] nsock_trace_handler_callback(): Callback: WRITE SUCCESS for EID 27 [172.16.66.2:53]
NSOCK INFO [0.1250s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 18 [172.16.66.2:53] (72 bytes): .............156.32.33.45.in-addr.arpa..................scanme.nmap.org.
NSOCK INFO [0.1250s] nsock_read(): Read request from IOD #1 [172.16.66.2:53] (timeout: -1ms) EID 34
NSOCK INFO [0.1250s] nsock_iod_delete(): nsock_iod_delete (IOD #1)
NSOCK INFO [0.1250s] nevent_delete(): nevent_delete on event #34 (type READ)
CONN (0.1261s) TCP localhost > 45.33.32.156:80 => Operation now in progress
CONN (0.1572s) TCP localhost > 45.33.32.156:80 => Connected
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.0041s latency).
Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f

PORT   STATE SERVICE
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 0.16 seconds
```

* On voit 4 contrôles pour voir si l'hôte est en vie:
- ping
- SYN
- ACK 
(envois un SYN et un ACK directement sans attendre le SYNACK. Les deux avec des numéros de séquences aléatoires
Le serveur répond par un RA (reset ack)
- timestamp request

__=> c'est l'empreinte de nmap !__

# Conclusion
*  Quand on utilise nmap il y a une empreinte, tous les par feu (actifs, à jour, géré) le savent et vont gueuller.
=> Il faut suprimer l'empreinte depuis le code source et le recompiler.


__NMAP est un outil puissant mais facile à détecter__


## Autres outils

### Amap
* Amap est un concurent de nmap mais sans empreinte, seulement il est moins puissant.

```
amap scanme.nmap.org 80
```

```
amap v5.4 (www.thc.org/thc-amap) started at 2020-10-15 09:35:35 - APPLICATION MAPPING mode

Protocol on 45.33.32.156:80/tcp matches http
Protocol on 45.33.32.156:80/tcp matches http-apache-2

Unidentified ports: none.

amap v5.4 finished at 2020-10-15 09:35:41
```

```
amap scanme.nmap.org 31337
```

```
amap v5.4 (www.thc.org/thc-amap) started at 2020-10-15 09:37:26 - APPLICATION MAPPING mode

Unidentified ports: 45.33.32.156:31337/tcp (total 1).
amap v5.4 finished at 2020-10-15 09:37:33

```

```
amap scanme.nmap.org 29
```

```
amap v5.4 (www.thc.org/thc-amap) started at 2020-10-15 09:37:26 - APPLICATION MAPPING mode

Unidentified ports: 45.33.32.156:31337/tcp (total 1).
amap v5.4 finished at 2020-10-15 09:37:33
```

* Peut renvoyer les données en hexa si il identifie pas

### ping

```
ping 8.8.8.8
```

* Envoyer x ping
```
ping -c 6 8.8.8.8
```

* Taille octet d'un ping
```
ping -s 2000 8.8.8.8
```

* flood => envoyer autant de ping que la carte et le reseau peut
```
ping -f 2000 8.8.8.8
```

Ne pas faire dans un réseau surveiller mais dans un pourrie sur un serveur, permet de savoir il est facilement dans les choux, sature vite.

* intervale en seconde
```
ping -i 15 8.8.8.8
```

* burst  : envoie XX pings à balle puis ping normal
```
ping -l 50 8.8.8.8
```
=> permet de bypass les par feu tout en sachant si un serveur est pourrie, le par feu va s'en foutre de 30 ping rapide


### tcptraceroute

```
sudo tcptraceroute 8.8.8.8
```

# Active information gathering - via l'être humain

sociel-engineer.org

manuel de l'armée : FM2-223
- Alertness => être à l'alert de chaque détails (plissage de front => defensive) etc
- Patience / tact
- credibilité
- Objectivité
- Adaptabilité
- Persévérences

* Elements

Terre => etat émotionnel stable : difficile à énerver / aime pas le changement / paresse
Eau => Changement rapide état emmotionnel : Difficile à cerner et contrôler / facilement en colère
Feu => Contrôle émotionnel :  cagressif, dominant / ego, puissance => faut faire peur pour dominer
Vent => Intelligence emmotionelle : ampathie, sensible / bénévolat / aime aider / manifeste geste amour => sympathique
Néant => Créactivité / diriger son énergie à réveler l'élément des autres => vanité, ego 


classer dans les catégories : 
1) vous camarade ? 
2) vous profs ? 
3) Vous ?









